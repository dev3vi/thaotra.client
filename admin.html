<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>T & T - Quản trị ảnh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://fonts.googleapis.com/css?family=Work+Sans:400,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #f5f6fa;
      font-family: 'Work Sans', sans-serif;
    }
    .login-box {
      max-width: 380px;
      margin: 100px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      padding: 30px;
    }
    .login-box h3 {
      text-align: center;
      font-weight: 600;
      margin-bottom: 20px;
    }
    .container-admin {
      max-width: 1100px;
      margin: 40px auto;
      display: none;
    }
    .panel {
      border-radius: 10px;
      overflow: hidden;
    }
    .thumb {
      width: 100%;
      height: 160px;
      object-fit: cover;
      display: block;
    }
    .badge-url {
      background: #eef5ff;
      border: 1px solid #cfe1ff;
      color: #2762d7;
      padding: 2px 6px;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <!-- Login -->
  <div id="loginPage" class="login-box">
    <h3>Đăng nhập quản trị</h3>
    <div class="form-group">
      <label>Tên đăng nhập</label>
      <input id="username" class="form-control" placeholder="Nhập username" />
    </div>
    <div class="form-group">
      <label>Mật khẩu</label>
      <input id="password" class="form-control" type="password" placeholder="Nhập password" />
    </div>
    <button id="btnLogin" class="btn btn-primary btn-block">Đăng nhập</button>
    <div id="loginError" class="text-danger text-center" style="margin-top:10px;display:none;">Sai tài khoản hoặc mật khẩu!</div>
  </div>

  <!-- Admin -->
  <div id="adminPage" class="container-admin">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Quản trị ảnh</h2>
      <button id="btnLogout" class="btn btn-danger">Đăng xuất</button>
    </div>

    <div class="panel panel-default">
      <div class="panel-heading">Tải ảnh lên</div>
      <div class="panel-body">
        <div id="dropzone"
          style="border:2px dashed #ccc;border-radius:12px;padding:26px;text-align:center;background:#fafafa;cursor:pointer">
          <p>Kéo & thả ảnh hoặc <button id="btnPick" class="btn btn-primary">Chọn ảnh</button></p>
          <input id="fileInput" type="file" accept="image/*" multiple style="display:none" />
        </div>
        <div id="queue" class="row" style="margin-top:18px;display:none"></div>
      </div>
    </div>

    <div class="panel panel-default">
      <div class="panel-heading" style="display:flex;justify-content:space-between;align-items:center;">
        <span>Thư viện ảnh</span>
        <button id="btnRefresh" class="btn btn-default btn-sm">Làm mới</button>
      </div>
      <div class="panel-body">
        <ul id="gallery" class="row"
          style="list-style:none;padding:0;margin:0;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));grid-gap:18px;">
        </ul>
        <div id="emptyHint" class="text-center" style="color:#999;display:none">Chưa có ảnh nào.</div>
      </div>
    </div>
  </div>

  <script>
    const ENDPOINTS = {
      LOGIN: '/api/login', // endpoint login (POST)
      LIST: '/api/get-files',
      UPLOAD: '/api/upload-file',
      DELETE: '/api/delete-file'
    };

    // --- Helpers ---
    const $ = (s, p=document) => p.querySelector(s);
    const tokenKey = 'adminToken';

    // --- Auth control ---
    async function login(username, password) {
      const res = await fetch(ENDPOINTS.LOGIN, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      if (!res.ok) throw new Error('Login failed');
      const data = await res.json();
      if (data.code === '00' && data.token) {
        localStorage.setItem(tokenKey, data.token);
        return true;
      }
      throw new Error('Sai tài khoản');
    }

    function logout() {
      localStorage.removeItem(tokenKey);
      $('#adminPage').style.display = 'none';
      $('#loginPage').style.display = 'block';
    }

    function authHeader() {
      const t = localStorage.getItem(tokenKey);
      return t ? { 'Authorization': 'Bearer ' + t } : {};
    }

    // --- Gallery logic ---
    async function loadGallery() {
      const g = $('#gallery');
      g.innerHTML = '';
      $('#emptyHint').style.display = 'none';
      const res = await fetch(ENDPOINTS.LIST, { headers: authHeader() });
      const json = await res.json();
      const files = json.data || [];
      if (!files.length) { $('#emptyHint').style.display = 'block'; return; }
      const origin = window.location.origin;
      files.forEach(f => {
        const url = f.fileUrl.startsWith('http') ? f.fileUrl : origin + f.fileUrl;
        const li = document.createElement('li');
        li.className = 'card';
        li.innerHTML = `
          <img class="thumb" src="${url}" alt="${f.fileName}">
          <div class="card-body">
            <div style="font-weight:600">${f.fileName}</div>
            <div><span class="badge-url" data-url="${url}">Sao chép URL</span></div>
            <div style="margin-top:6px">
              <a href="${url}" target="_blank" class="btn btn-xs btn-default">Xem</a>
              <button class="btn btn-xs btn-danger btn-del" data-name="${f.fileName}">Xoá</button>
            </div>
          </div>`;
        g.appendChild(li);
      });
      g.querySelectorAll('.btn-del').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('Xoá ảnh này?')) return;
          await fetch(`${ENDPOINTS.DELETE}?fileName=${btn.dataset.name}`, {
            method: 'DELETE',
            headers: authHeader()
          });
          loadGallery();
        });
      });
      g.querySelectorAll('.badge-url').forEach(b => {
        b.addEventListener('click', async () => {
          await navigator.clipboard.writeText(b.dataset.url);
          b.textContent = 'Đã sao chép!';
          setTimeout(() => b.textContent = 'Sao chép URL', 1200);
        });
      });
    }

    // --- Upload logic ---
    function validateAndUpload(file) {
      if (!file.type.startsWith('image/')) return alert('Không phải ảnh!');
      if (file.size > 10 * 1024 * 1024) return alert('Ảnh quá 10MB!');
      const form = new FormData();
      form.append('file', file);
      fetch(ENDPOINTS.UPLOAD, {
        method: 'POST',
        headers: authHeader(),
        body: form
      }).then(r => r.json()).then(() => loadGallery());
    }

    // --- UI bindings ---
    $('#btnLogin').onclick = async () => {
      const user = $('#username').value.trim();
      const pass = $('#password').value.trim();
      try {
        await login(user, pass);
        $('#loginPage').style.display = 'none';
        $('#adminPage').style.display = 'block';
        loadGallery();
      } catch (e) {
        $('#loginError').style.display = 'block';
      }
    };
    $('#btnLogout').onclick = logout;
    $('#btnPick').onclick = () => $('#fileInput').click();
    $('#fileInput').onchange = e => [...e.target.files].forEach(validateAndUpload);
    $('#btnRefresh').onclick = loadGallery;

    // --- Auto login if token exists ---
    if (localStorage.getItem(tokenKey)) {
      $('#loginPage').style.display = 'none';
      $('#adminPage').style.display = 'block';
      loadGallery();
    }
  </script>
</body>
</html>
